#!/usr/bin/env bash

# copyright 2023.
#
# licensed under the apache license, version 2.0 (the "license");
# you may not use this file except in compliance with the license.
# you may obtain a copy of the license at
#
#     http://www.apache.org/licenses/license-2.0
#
# unless required by applicable law or agreed to in writing, software
# distributed under the license is distributed on an "as is" basis,
# without warranties or conditions of any kind, either express or implied.
# see the license for the specific language governing permissions and
# limitations under the license.
#

set -eu -o pipefail

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)

source "${SCRIPT_DIR}"/common

declare SHOW_HELP=false
declare COLLECTION_DIR=""

parse_args() {
	while [[ -n "${1+xxx}" ]]; do
		case $1 in
		-h | --help)
			SHOW_HELP=true
			return 0
			;;
		-ns | --ns)
			shift
			OPERATOR_NS="$1"
			shift
			;;
		-op | --operator)
			shift
			OPERATOR="$1"
			shift
			;;
		-path | --path)
			shift
			COLLECTION_DIR="$1"
			shift
			;;
		*)
			return 1
			;;
		esac

	done

	export OPERATOR OPERATOR_NS
	return 0
}

print_usage() {
	local scr
	scr="$(basename "$0")"

	read -r -d '' help <<-EOF_HELP || true
		Usage:
		  $scr
		  $scr  --ns | -n
		  $scr  --operator | -op
		  $scr  --path | -path


		 ─────────────────────────────────────────────────────────────────

		Options:
		  --operator | -op OPERATOR     specify the name of operator that is deployed
		                                  default: $OPERATOR
		  --ns | -n NAMESPACE           namespace where the operator is deployed
			                                  default: $OPERATOR_NS
		  --path | -path PATH           gather collection path
			                                  default: /must-gather



	EOF_HELP

	echo -e "$help"
	return 0

}

get_kepler_internal_instances() {
	log "getting kepler internal instance(s)"
	KEPLER_INTERNALS=$(oc get keplerinternals.kepler.system.sustainable.computing.io -oname)
	if [ -n "$KEPLER_INTERNALS" ]; then
		run oc get "$KEPLER_INTERNALS" -oyaml "$BASE_COLLECTION_PATH/kepler-internals.yaml"
	else
		echo "no kepler internals found" >>"$BASE_COLLECTION_PATH/kepler-internals.yaml"
	fi
}

get_kepler_instance() {
	log "getting kepler instance(s)"
	local ns=""
	ns=$(oc get keplerinternals kepler -o jsonpath='{.spec.exporter.deployment.namespace}') && {
		export KEPLER_NS=$ns
	}
	KEPLERS=$(oc get keplers.kepler.system.sustainable.computing.io -oname)
	if [ -n "$KEPLERS" ]; then
		run oc get "$KEPLERS" -oyaml "$BASE_COLLECTION_PATH/keplers.yaml"
	else
		echo "no keplers found" >>"$BASE_COLLECTION_PATH/keplers.yaml"
	fi
}

get_kepler_events() {
	log "getting $KEPLER_NS events"
	run oc -n "$KEPLER_NS" get events "$BASE_COLLECTION_PATH/$KEPLER_NS""_events"
}

get_kepler_daemon_set() {
	log "getting kepler exporter daemonset"
	run oc -n "$KEPLER_NS" get ds kepler -oyaml "$BASE_COLLECTION_PATH/kepler-ds.yaml"
}

get_kepler_config_map() {
	log "getting kepler exporter config map"
	run oc -n "$KEPLER_NS" get cm kepler -oyaml "$BASE_COLLECTION_PATH/kepler-cm.yaml"
}

get_kepler_sa() {
	log "getting kepler exporter service account"
	run oc -n "$KEPLER_NS" get serviceaccount kepler -oyaml "$BASE_COLLECTION_PATH/kepler-sa.yaml"
}

get_kepler_scc() {
	log "getting kepler exporter scc"
	run oc get scc kepler -oyaml "$BASE_COLLECTION_PATH/kepler-scc.yaml"
}

gather_kepler_exporter_info() {
	KEPLER_PODS=$(oc -n "$KEPLER_NS" get pods -oname 2>/dev/null || echo "")
	for pod in $KEPLER_PODS; do
		pod=$(echo "$pod" | awk -F '/' '{print $2}')
		log "running gather script for kepler pod: $pod"
		"$SCRIPT_DIR"/gather-kepler-exporter-info "$BASE_COLLECTION_PATH" "$pod"
	done
}

gather_olm_info() {
	log "running gather script for olm"
	"$SCRIPT_DIR"/gather-olm-info "$BASE_COLLECTION_PATH"
}

gather_operator_info() {
	log "getting $OPERATOR info"
	"$SCRIPT_DIR"/gather-operator-info "$BASE_COLLECTION_PATH"
}

gather_monitoring_info() {
	log "getting monitoring info"
	"$SCRIPT_DIR"/gather-monitoring-info "$BASE_COLLECTION_PATH"
}

main() {

	parse_args "$@" || {
		print_usage
		echo "failed parsing args"
		return 1
	}
	$SHOW_HELP && {
		print_usage
		return 0
	}

	BASE_COLLECTION_PATH="${COLLECTION_DIR:-/must-gather}"
	# NOTE: convert relative to absolute path
	BASE_COLLECTION_PATH="$(readlink -f "$BASE_COLLECTION_PATH")"
	export LOGFILE_PATH="${BASE_COLLECTION_PATH}/${LOGFILE_NAME}"

	mkdir -p "${BASE_COLLECTION_PATH}"
	cd "${BASE_COLLECTION_PATH}"
	echo -e "must-gather logs are located at: '${LOGFILE_PATH}'"

	mkdir -p "/tmp/cache-dir"
	export KUBECACHEDIR=/tmp/cache-dir

	echo "powermon must-gather started..."
	gather_olm_info
	gather_operator_info
	get_kepler_instance
	get_kepler_internal_instances
	get_kepler_events
	get_kepler_daemon_set
	get_kepler_config_map
	get_kepler_sa
	get_kepler_scc
	gather_kepler_exporter_info
	gather_monitoring_info

	echo "powermon must-gather completed"
}

main "$@"
